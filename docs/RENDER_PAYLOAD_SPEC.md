# 📦 RENDER_PAYLOAD_SPEC  
_DARF Frame-Layer Payload Definition_

**Spec Version**: 1.0  
_Last updated: June 29, 2025_

---

## 🧠 Purpose

This spec defines the structure and constraints of each `render_payload.json` file dispatched from the controller to an eligible Android node.

Payloads describe **what to render**, **how to render it**, and **where to send results**—nothing more.  
Execution logic lives with the node; intelligence lives with the controller.

## 📁 File Location

Payloads are JSON files generated by the controller and written to disk for dispatch.  
Typically stored in:

```text
/controller/outgoing/render_payloads/
```

---

## 🧱 JSON Schema

This section defines the structure of a valid `render_payload.json` file.  
Fields are case-sensitive unless otherwise stated.

### 📄 Root Structure

The root JSON defines the required and optional top-level fields of a DARF render payload.

```json
{
  "version": "1.0",
  "job_id": "string",
  "frame_id": "string",
  "output_name": "string",
  "layers": [ ... ],
  "render_settings": { ... },
  "return_path": "string",
  "node_metadata": { ... }
}
```

---

### 🎨 Layer Object

Each entry in the `layers` array defines one visual layer in the frame.  
At least one valid layer is required per payload.

```json
{
  "layer_key": "lines",                    // Identifier (e.g. "shadow", "lines", "bg")
  "image_path": "/frames/001_lines.png",  // Absolute or relative path
  "opacity": 1.0,                          // Optional: float (0.0–1.0)
  "blend_mode": "normal",                 // e.g. "multiply", "screen"
  "render_pass": "base"                   // Optional pass type
}
```

### ⚙️ Global Render Settings

These apply to the entire payload and affect all layers unless overridden in the future.

```json
{
  "output_format": "png",        // "png", "webp", or "jpg"
  "resolution_scale": 1.0,       // Multiplier for output resolution (e.g. 2.0 = 2x scale)
  "compression": 90,             // For jpg/webp: 0 (low quality) to 100 (max)
  "composite": false             // true = merge layers into one image; false = layer-by-layer
}
```

### 💾 Return Path

Specifies where the node should deliver completed render output.

```json
"return_path": "http://10.0.0.5:8200/upload/frame123/"
```

This can be:

A local path (e.g. "C:/render/output/")

A networked share

An HTTP or HTTPS POST endpoint

DARF nodes do not validate the success of the upload target—only that delivery was attempted.

### 🧠 Optional Node Metadata

These hints may be provided by the controller to influence runtime behavior. Nodes may ignore unsupported fields.

```json
{
  "priority": 1,                     // 0 (lowest) to 10 (highest priority)
  "max_render_time_ms": 30000,      // Soft cap in milliseconds
  "render_tag": "night_batch_01",   // Identifier for job grouping or logging
  "preferred_core_count": 2         // Suggested thread usage for headless renderer
}
```

## ✅ Minimal Valid Payload

This is the smallest acceptable `render_payload.json` that will pass validation:

```json
{
  "version": "1.0",
  "job_id": "job_00002",
  "frame_id": "frame_001",
  "output_name": "cat_bounce_001",
  "layers": [
    {
      "layer_key": "lines",
      "image_path": "/frames/001_lines.png"
    }
  ],
  "render_settings": {
    "output_format": "png",
    "composite": false
  },
  "return_path": "http://10.0.0.5:8000/api/submit"
}
```

## 🚫 Invalid Payload Conditions

A payload is considered invalid if:

- `"layers"` is empty or missing
- `"image_path"` points to an unreadable, missing, or malformed location
- `"version"` is unrecognized or unsupported by the node
- `"return_path"` is not a valid URL or accessible local file path
- `"output_name"` is missing or includes disallowed characters

## 📌 Notes

- This spec supports PNGs, WebPs, JPGs, and future image formats
- All file paths must be absolute or properly container-mounted
- Payloads are case-sensitive unless otherwise specified
- Nodes must validate payloads before rendering and exit cleanly on failure
- All payloads are designed to be stateless—no caching assumptions allowed

## 🔮 Future Extensions

The following fields and behaviors are planned for future phases of DARF:

| Feature                        | Description                                      | Status         |
|-------------------------------|--------------------------------------------------|----------------|
| `audio_sync` metadata         | Audio-frame alignment and delay metadata         | Planned        |
| Multi-frame composite bundles | Grouped renders with inter-frame dependencies    | In discussion  |
| Layer masking per input       | Optional per-layer matte channels                | Phase 5        |
| 2D filter pass support        | e.g. blur, levels, glow per layer/frame          | Phase 5–6      |
| Payload signing + hash check  | Verify authenticity of controller-dispatched job | Drafting       |
| `render_script` override      | Sandbox execution logic per payload              | Drafting       |
| Animation profile hints       | e.g. hold frames, exposure mapping hints         | Planned        |
| Batch ROI estimation          | Yield-to-power forecasting for node prioritizing | In discussion  |

All experimental fields will be documented and versioned before implementation.

---

DARF doesn’t render assumptions.  
It renders specifications.
